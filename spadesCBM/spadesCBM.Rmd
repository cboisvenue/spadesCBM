---
title: "spadesCBM"
author: ''
date: "September 2018"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---
# Overview

The theme here is "Transparency, flexibility and science improvement in CFS carbon modelling". 

## Background
This is a family of SpaDES modules that emulates the science in CBM-CFS3. It was developed on the SpaDES platform (a package in R - https://cran.r-project.org/web/packages/SpaDES/index.html) to make it transparent, spatial explicit and flexible. It is meant to be an environment in which science improvements can be explored and tested. These include links to other models for multi-use decision making and carbon science improvements. The computing difference with CBM-CFS3 is that the operations on the carbon pools are done by matrix multiplications instead of simple multiplication. Being in the SpaDES environment, it is meant to be run spatially explicitly which assumes that the required inputs are spatially explicit.

# Three-module family

The family of modules is called from a parent module named spadesCBM. The spadesCBM parent module calls three child modules: spadesCBMdefaults, spadesCBMinputs, and spadesCBMcore. The code environment is on a private repository here: https://github.com/cboisvenue/spadesCBM.git.



The two first modules have a parsing file (the R file that has all the functions - spadesCBMdefaultFunctions.r, spadesCBMinputsFunctions.r). 
spadesCBMdefaultFunctions.r has r-language functions to build and query the S4 object cbmData. spadesCBMinputsFunctions.r, has r-language hashing functions and calls on the library "CBMVolumeToBiomass". This library was build by Scott Morken to apply the Boudewyn et al stand-level parameters to growth curve information for a translation into biomass pools. This library needs to be already built before running this module.
spadesCBMcoreFunctions.r compiles the Rcpp code in .InputObjects of spadesCBMcore.R (it has no parsing file). The compiled code is cached in the cache directory  `cacheDir = cachePath(sim), env = envir(sim)`

Many more details of this three-modules family are in G:\RES_Work\Work\SpaDES\spadesCBM\Prezi WIN spadesCBM modules ov.exe, which is also a working document.

### spadesCBMdefaults 
This module has one event (init) and does not schedule anything else. It requires the "dbPath" and "sqlDir" to run. This present .rmd file creates "dbPath" and "sqlDir" (see below) and so does the .InputObjects section of spadesCBMdefault.R so that the spadesCBMdefault can run independently from the two other modules or from this parent module. This module loads all the CBM-CFS3 default parameters (Canadian defaults that is akin to the ArchiveIndex access database in CBM-CFS3). It is read as an S4 object called cbmData. This object has the following slot names "turnoverRates" (15byb13 full), "rootParameters" (48by7 full), "decayParameters" (11X6 full), "spinupParameters"(48by4 full), "classifierValues"(0X0), "climate" (48by2 full - mean annual temp), "spatialUnitIds" (48by3 full), "slowAGtoBGTransferRate"(1by1 0.006), "biomassToCarbonRate"(1by1 0.5),"ecoIndices" (0by0), "spuIndices" (0by0), "stumpParameters" (48by5 full), "overmatureDeclineParameters" (48by4 full), "disturbanceMatrix" (426X3 - character matrix with word descriptions of disturbances ["id" "name" "description"]). The whole sqlite db that contains the defaults is read/accessible via C:\Celine\GitHub\spadesCBM\exploringCode\readInSQLiteData.r.

### spadesCBMinputs
This module has one event (init) and does not schedule anything else. This module reads in information that is expected to be provided by the user: the growth curves, the ages of the stands/pixels, links between each stand and the growth curves, and where these stands are in Canada (which provides a link to the default parameters read-in by the previous module). It translates the m3/ha into the biomass pools and carbon curve using the CBMVolumeToBiomass.dll (by Scott Morken) which is done using the Boudewyn et al. stand-level parameters (this will eventually be a separate module for transparency). The CBMVolumeToBiomass library needs to already by built to run this module. This module will read-in spatially explicit data (eventually). It reads-in min and max rotation lengths, mean fire return interval, provided a place for regeneration delays, and this is the place where you will tell the model where you are (which ecozone and spatial unit). The disturbance events also go in here (what and what date).

## spadesCBMcore
This module completes the simulations of the spadesCBM. It has five events: spinup, postSpinup, saveSpinup, annual, and savePools, with the saveSpinup being optional. The spinup event is in the init, and it runs the traditional spinup similarly to CBM-CFS3 where each stand is disturbed using the "historicDMIDs" and re-grown using the provided growth curves, until the DOM pools "fill-up" and stabilize.  A user can set a minimun and a maximum number of rotations, and the disturbance return interval ("minRotations", "maxRotations", "returnIntervals" set in the spadesCBMinput module) for the spinup. Once the DOM pools have stabilized, the spinup event growths the stand (still using the same growth curve) to the user-provided age of that stand/pixel ("ages" created in spadesCBMinputs module). If spinupDebug is set to FALSE, the spinup event provides a line for each stand with the intial pool values to initialize the stands/pixels for the annual simulations. These are assigned in postSpinup event. In the postSpinup event, matrices are set up for the processes that will happen in the annual event. The annual event is where all the processes are applied and the savePools event is scheduled last to save a .csv of the final pool values.

### DANGER with the spinupDebug parameter
The spinupDebug parameter is a logical parameter defined in the metadata of the spadesCBMcore.R module. It determines if the results from the spinup will be saved as an external file. The default is FALSE. If this is set to TRUE, the postSpinup event re-runs the cpp Sinup function because the cpp Spinup function actually uses the sinpupDebug and spits-out all the runs for all the stand/pixelss until the stabilization of the DOM pools instead of the DOM for each stand needed to start the annual simulation runs. This could take a long time if you have a lot of stands/pixels. This can be changed later, it was a work around to get these modules running. 

## Known Errors carried over from carb1
Error in Spinup(pools = sim$pools, opMatrix = opMatrix, constantProcesses = sim$processes,  : 
  Expecting a single value: [extent=0].
This is because the pooldef values are expected to be in the .GlobalEnv due to a function inside RCMBGrowthIncrements.cpp . That file should be changed so it is not looking in .GlobalEnv. Current work around is to place all the pooldef values in .GlobalEnv. This happens inside the ".inputObjects" function.

# Usage

```{r module_usage}
library(SpaDES)

moduleDir <- file.path(getwd())#"C:/Celine/GitHub/spadesCBM")
inputDir <- file.path(moduleDir,"data") %>% reproducible::checkPath(create = TRUE) #"C:/Celine/GitHub/spadesCBM/data")
outputDir <- file.path(moduleDir,"outputs") #"C:/Celine/SpaDEScacheOutputs/outputs")
cacheDir <- file.path(outputDir,"cache")#C:/Celine/SpaDEScacheOutputs/cache")
times <- list(start = 1990.00, end = 1999.00)
parameters <- list(
  spadesCBMcore = list(.useCache = TRUE),
  spadesCBMinputs = list(.useCache = TRUE),
  spadesCBMdefaults = list(.useCache = TRUE)
)

modules <- list("spadesCBM")
objects <- list(
  dbPath = file.path(inputDir,"cbm_defaults","cbm_defaults.db"),
  sqlDir = file.path(inputDir,"cbm_defaults")
  )
paths <- list(
  cachePath = cacheDir,
  modulePath = moduleDir,
  inputPath = inputDir,
  outputPath = outputDir
  )

spadesCBMSim <- simInit(times = times, params = parameters, 
                    modules = modules,
                 objects = objects, paths = paths)

spadesCBMout <- spades(spadesCBMSim,debug=TRUE)
```

# Noteworthy objects

- pooldef: names of all the pools that also have a memory spot saved in teh .Globals right now
- allMatrices: return the matrix ids of the loaded matrices
- decayRates: matrix 48X12 - holds the decay rates for all the dom pools (11 of them) per spatial unit. Where is this created? How does it link to the "decay_parameter" table in cbmData?
- carbonCurve: this is the result from using all the growth curves and "translating" them into biomass compartments using SMorken's CBMVolumeToBiomass library and its function VolumeToBiomassConvert(). This is one of the components that will need to be made into an independent module and more transparent
- growth_increments: not convinced we need this to be in the sim environment...but, it would be good to have this easily visible.
- processes: this is a list of "matrixHash"-ed (R function in spadesCBMinputsFunctions.r) of domDecay, slowDecay, slowMixing, domTurnover, bioTurnover, disturbanceMatrices. 



## Plotting

Nothing for now.

## Saving

Pools at the end of all runs via the savePools event of the spadesCBMcore module.

# Data dependencies

## Input data

Working on using the spatial data from SK. These are stored here C:\Celine\Syndocs\RES_Work\Work\SpaDES\SK_data. Eventually external sources of growth and yield and forest inventory can be used.

## Output data

See G:\RES_Work\Work\SpaDES\spadesCBM\Prezi WIN spadesCBM modules ov.exe for now

# Links to other modules

This will be linked to the SpaDES caribou models, to the SpaDES version of LANDIS-II, and to any other available SpaDES modules available (growth and yield?).

