---
title: "spadesCBM"
author: ""
date: "19 January 2018"
output: pdf_document
editor_options: 
  chunk_output_type: console
---
# Overview

The theme here is "Transparency, flexibility and science improvement in CFS carbon modelling". 

## Background
In summer 2017 Scott Morken wrote a second incarnation of a CBM-like R-based carbon model in an intensive 2-week stint with EMcIntire and CBoisvenue. The code and scripts, including the calls to Cpp via RCpp, are all contained in RunSK_new.R. This emulates the science in CBM-CFS3 but works in matrix operations (the original CBM-CFS3 does not). Scott got a spin up working with a comparison for 1 stand in SK, which he ran for 100 years post spin-up in both CBMCFS3 and the script as developed here. Results are the same compared to classic CBMCFS3 (see C:\Celine\GitHub\RCBM\data\12_Spades_run\CBM3BaselineTesting). A map of the links and functions of the R and cpp code (created by CBoisvenue) is avaible here (G:\RES_Work\Work\SpaDES\work\RCBMoverview\June2017CBMcore\cbmCoreMap.xlsx).


# Three-module family
One SpaDES module was developped to run the exact same script as RunSK-new.R. This SpaDES module is called carb1. There is a tagged version of it exists on the private github repo https://github.com/smorken/RCBM. (soon to be transferred to https://github.com/cboisvenue/RCBM)

The SpaDES module carb1 was separated into three spadesCBM-family modules: spadesCBMdefaults, spadesCBMinputs, and spadesCBMcore. These are three child modules that are run by the present spadesCBM parent module. These are in the master branch here: https://github.com/cboisvenue/spadesCBM.git

### spadesCBMdefaults 
This module has one event (init) and does not schedule anything else. It requires the "dbPath" and "sqlDir" that this present .rmd file creates (see below) to run. This module loads all the CBM-CFS3 default parameters (Canadian defaults that is akin to the ArchiveIndex access database in CBM-CFS3). Amongst other objects created in the sim environment, a key one is an S4 object called cbmData. This object has the following slot names "turnoverRates" (15byb13 full), "rootParameters" (48by7 full), "decayParameters" (11X6 full), "spinupParameters"(48by4 full), "classifierValues"(0X0), "climate" (48by2 full - mean annual temp), "spatialUnitIds" (48by3 full), "slowAGtoBGTransferRate"(1by1 0.006), "biomassToCarbonRate"(1by1 0.5),"ecoIndices" (0by0), "spuIndices" (0by0), "stumpParameters" (48by5 full), "overmatureDeclineParameters" (48by4 full), "disturbanceMatrix" (426X3 - character matrix with word descriptions of disturbances ["id" "name" "description"]).

### spadesCBMinputs
This module has one event (init) and does not schedule anything else. This module reads in information that is expected to be provided by the user: the growth curves, the ages of the stands/pixels, links between each stand and the growth curves, and where these stands are in Canada (which provides a link to the default parameters read-in by the previous module). It translates the m3/ha into the biomass pools and carbon curve using the CBMVolumeToBiomass.dll (by Scott Morken) which  is using the Boudewyn et al. stand-level parameters (this will eventually be a separate module for transparency). The CBMVolumeToBiomass library needs to already by built to run this module. This module will read-in spatially explicit data (eventually). It reads-in min and max rotation lentghts, mean fire return interval, provided a place for regeneragtion delays, and this is the place where you will tell the model where you are (which ecozone and spatial unit). The disturbance events also go in here (what and what date).

## spadesCBMcore
This module completes the simulations of the spadesCBM. It has five events: spinup, postSpinup, saveSpinup, annual, and savePools, with the saveSpinup being optional. The spinup event is in the init, and it runs the traditional spinup similarly to CBM-CFS3 where each stand is disturbed using the "historicDMIDs" and re-grown using the provided growth curves, until the DOM pools "fill-up" and stabilize.  A user can set a minimun and a maximum number of rotations, and the disturbance return interval ("minRotations", "maxRotations", "returnIntervals" set in the spadesCBMinput module) for the spinup. Once the DOM pools have stabilized, the spinup event growths the stand (still using the same growth curve) to the user-provided age of that stand/pixel ("ages" created in spadesCBMinputs module). If spinupDebug is set to FALSE, the spinup event provides a line for each stand with the intial pool values to initialize the stands/pixels for the annual simulations. These are assigned in postSpinup event. In the postSpinup event, matrices are set up for the processes that will happen in the annual event. The annual event is where all the processes are applied and the savePools event is scheduled last to save a .csv of the final pool values.

### DANGER with the spinupDebug parameter
The spinupDebug parameter is a logical parameter defined in the metadata of this module (in spadesCBMcore.R). It determines if the results from the spinup will be saved as an external file. The default is FALSE. If this is set to TRUE, the postSpinup event re-runs the cpp Sinup function because the cpp Spinup function actually uses the sinpupDebug and spits-out all the runs of for all the stands until the stabilization of the DOM pools instead of the DOM for each stand needed to start the annual simulation runs. This could take a long time if you have a lot of stands/pixels. This can be changed later, it was a work around to get these modules running. 

## Known Errors carried over from carb1
Error in Spinup(pools = sim$pools, opMatrix = opMatrix, constantProcesses = sim$processes,  : 
  Expecting a single value: [extent=0].
This is because the pooldef values are expected to be in the .GlobalEnv due to a function inside RCMBGrowthIncrements.cpp . That file should be changed so it is not looking in .GlobalEnv. Current work around is to place all the pooldef values in .GlobalEnv. This happens inside the ".inputObjects" function.

# Usage

```{r module_usage}
library(SpaDES)

moduleDir <- file.path("C:/Celine/GitHub/spadesCBM")
inputDir <- file.path("C:/Celine/GitHub/data/12_Spades_run") %>% reproducible::checkPath(create = TRUE)
outputDir <- file.path("C:/Celine/SpaDEScacheOutputs/outputs")
cacheDir <- file.path("C:/Celine/SpaDEScacheOutputs/cache")
times <- list(start = 1990.00, end = 1999.00)
parameters <- list(
  #.progress = list(type = "text", interval = 1), # for a progress bar
  ## If there are further modules, each can have its own set of parameters:
  spadesCBMcore = list(.useCache = c(".inputObjects", "init")),
  spadesCBMinputs = list(.useCache = c(".inputObjects")),
  spadesCBMdefaults = list(.useCache = c(".inputObjects"))
#module1 = list(param1 = value1, param2 = value2),
  #module2 = list(param1 = value1, param2 = value2)
)
modules <- list("spadesCBM")
objects <- list(
  dbPath = file.path(inputDir,"cbm_defaults","cbm_defaults.db"),
  sqlDir = file.path(inputDir,"cbm_defaults")

)
paths <- list(
  cachePath = cacheDir,
  modulePath = moduleDir,
  inputPath = inputDir,
  outputPath = outputDir
)

spadesCBMSim <- simInit(times = times, params = parameters, 
                    modules = modules,
                 objects = objects, paths = paths)

spadesCBMout <- spades(spadesCBMSim,debug=TRUE)
```

# Events
Each module has a parsing file (the R file that has all the functions - spadesCBMdefaultFunctions.r, spadesCBMinputsFunctions.r, spadesCBMcoreFunctions.r). spadesCBMdefaultFunctions.r mostly has functions to build and query the S4 object cbmData. spadesCBMinputsFunctions.r, the cpp code is compiled along with all the funcitons needed for the module. The compiled code is cached in the cache directory  `cacheDir = cachePath(sim), env = envir(sim)`

Describe what happens for each event type. There are 4 events.
Init
Init event reads in all the old cbmcfs3 parameters (similar to taking what is needed from the "Archive Index"). It also creates constant matrices using those parameters from the cbm_default.db files. For now, this also reads-in and processes the growth curves by gcid and spatial unit. This event adds to the sim environment:
- pooldef: names of all the pools that also have a memory spot saved in teh .Globals right now
- cbmdata: an S4 object that has the following slot names "turnoverRates" (15byb13 full), "rootParameters" (48by7 full), "decayParameters" (11X6 full), "spinupParameters"(48by4 full), "classifierValues"(0X0), "climate" (48by2 full - mean annual temp), "spatialUnitIds" (48by3 full), "slowAGtoBGTransferRate"(1by1 0.006), "biomassToCarbonRate"(1by1 0.5),"ecoIndices" (0by0), "spuIndices" (0by0), "stumpParameters" (48by5 full), "overmatureDeclineParameters" (48by4 full), "disturbanceMatrix" (217X3 - full - word descriptions linked to id...this is just saskatchewan I think), "disturbanceMatrixAssociation" (4642by3 full - type of matrix with matrix id), "disturbanceMatrixValues" , "disturbanceMatrixIndices" (), "disturbanceEvents", "landclasses", "pools", "domPools".          
- allMatrices: return the matrix ids of the loaded matrices
- decayRates: matrix 48X12 - holds the decay rates for all the dom pools (11 of them) per spatial unit
- carbonCurve: this is the result from using all the growth curves and "translating" them into biomass compartments using SMorken's CBMVolumeToBiomass library and its function VolumeToBiomassConvert(). This is one of the components that will need to be made into an independent module and more transparent
- growth_increments: not convinced we need this to be in the sim environment...but, it would be good to have this easily visible.
- processes: this is a list of "matrixHash"-ed (function above) of domDecay, slowDecay, slowMixing, domTurnover, bioTurnover, disturbanceMatrices. 

spinup

saveSpinup

postSpinup

annual

## Plotting

Write what is plotted.

## Saving

Write what is saved.

# Data dependencies

## Input data

How to obtain input data, and a description of the data required by the module.
If `sourceURL` is specified, `downloadData("spadesCBM", "path/to/modules/dir")` may be sufficient.

## Output data

Description of the module outputs.

# Links to other modules

Describe any anticipated linkages to other modules.

