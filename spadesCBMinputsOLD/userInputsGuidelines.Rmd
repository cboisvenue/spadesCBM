---
title: "userInputsGuidelines"
author: "CBoisvenue"
date: "09/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# spadesCBM user provided inputs

This document provides user guidance to create the necessary input to run spadesCBM, a family of SpaDES modules that emulates the science in CBM-CFS3. All defaults are for Canada. Parameters read-in by the spadesCBMdefault.r module are also for Canada. There are three main pieces of information that a user needs to provide: study area location, age of pixel/stand, and growth curve information. The use can also provide disturbance information, but defaults can also be used. The growth curve information needs to include the growth curve itself (userGcM3.csv), the leading species per growth curve (in the meta data gcMetaEg.cvs), and a link preferably in the form of a raster that indicates which growth curve to use for each per pixel/stand. To match all correct model default parameters (CBM-CFS3 legacy), all these have to be in a specific format, outlined below, and matched with CBM-CFS3 spatial units and Canada-level ecozones. The spatial unit and ecozones rasters are created in the spadesCBMinputs.r module. The growth curve information is translated into biomass increments in the spadesCBMm3ToBiomass.r module.

## spadesCBMinputs module

### Rasters

This module expects the user to provide rasters (masterRaster, ageRaster, gcIndexRaster) or URLs (masterRasterURL, ageRasterURL, gcIndexRasterURL) for the study area (masterRaster), ages (ageRaster), and a raster associating a growth curve to each pixel (gcIndexRaster). The processing of the growth curves from m3/ha to biomass increments per hectare by above ground pool is done if the spadesCBMm3ToBiomass, but the raster that specifies which growth curves is associated with which pixel is expected here (gcIndexRaster). There are a few ways the user can provide these, one is by passing in as an object in the master script for the module (spadesCBMinputs.Rmd) or parent module (spadesCBM.Rmd). For example in the raster URLs could be provided in the data folder in the module objects.
```{r eval=FALSE, echo=TRUE}
objects <- list(
  masterRasterURL = 
    c("https://drive.google.com/file/d/1zUyFH8k6Ef4c_GiWMInKbwAl6m6gvLJW/view?usp=sharing"),
  ageRasterURL = 
    c("https://drive.google.com/file/d/1hylk0D1vO19Dpg4zFtnSNhnyYP4j-bEA/view?usp=sharing"),
  gcIndexRasterURL = 
  c("https://drive.google.com/file/d/1yunkaYCV2LIdqej45C4F9ir5j1An0KKr/view?usp=sharing")
  )
```

The default examples provide a URL in the meta data of the module spadesCBMinputs for the default area in Saskatchewan.
```{r eval=FALSE, echo=TRUE}
inputObjects = bind_rows(
  expectsInput(objectName = "ageRasterURL", objectClass = "character", desc = "URL for ageRaster - optional, need this or a ageRaster"),
    expectsInput(objectName = "ageRaster", objectClass = "raster", desc = "Raster ages for each pixel", sourceURL = "https://drive.google.com/file/d/1hylk0D1vO19Dpg4zFtnSNhnyYP4j-bEA/view?usp=sharing"),
    expectsInput(objectName = "gcIndexRasterURL", objectClass = "character", desc = "URL for ageRaster - optional, need this or a ageRaster"),
    expectsInput(objectName = "gcIndexRaster", objectClass = "raster", desc = "Raster ages for each pixel", sourceURL = "https://drive.google.com/file/d/1yunkaYCV2LIdqej45C4F9ir5j1An0KKr/view?usp=sharing"),
    expectsInput(objectName = "spuRaster", objectClass = "raster", desc = "Raster has spatial units for each pixel"),
    expectsInput(objectName = "ecoRaster", objectClass = "raster", desc = "Raster has ecozones for each pixel"),
    expectsInput(objectName = "masterRasterURL", objectClass = "character", desc = "URL for masterRaster - optional, need this or a masterRaster"),
    expectsInput(objectName = "masterRaster", objectClass = "raster", sourceURL = "https://drive.google.com/file/d/1zUyFH8k6Ef4c_GiWMInKbwAl6m6gvLJW/view?usp=sharing",
                 desc = "Raster has NAs where there are no species and the pixel groupID where the pixels were simulated. It is used to map results")
)
```


The package SpaDES provides tools to help process input layers (see the package reproducible which includes the fundtion prepIntputs()) permitting other formats to be processed by the user. The masterRaster will be the template for the formatting of all other rasters. It is also used to determine the Spatial Units raster; a Spatial Unit (or spu) is a CBM-CFS3 spatial identification that associates modelling parameters to the specific location. Spus are an ordered sequence of the administrative boundaries (Provinces and Territories) and Canadian ecozones. The spuRaster (rasters that associates an spu to each pixel) is computed in the .inputObjects of the spadesCBMinputs module if it is not provided elsewhere. The masterRaster is also used to create the ecoRaster which associates an ecozone to each pixel. This is again calculated in the .inputObjects if it is not provided elsewhere. The defaults for all raster used in the example runs are for a region in Saskatchewan Canada. Run the defaults and use `Plot(outInputs$masterRaster)` to see the area.

### Disturbances

Disturbances in spadesCBM are defined in the same way as in CBM-CFS3, by a disturbance matrix. The disturbance matrices specify a proportion of carbon that will be moved from one of the 26 carbon pools (`sim$pooldef`) to another representing the effects of a disturbance on carbon in the stand/pixel. There are 426 pre-defined in the defaults of spadesCBM based on the archive index of CBM-CFS3, their names are here `sim$$cbmData@disturbanceMatrix`), and their proportions transfered are store here in SpaDES simulations here `sim$cbmData@disturbanceMatrixValues`. Specific disturbance matrices are associated with specific spatial unit (`sim$$cbmData@disturbanceMatrixAssociation`). Some of these are based on data and some on expert opinion. The user can provide a list of disturbances that will be represented in the simulations as per the default example userDist.csv, where four distinct disturbances are used. The names of the disturbances have to be taken from this list `outSim$cbmData@disturbanceMatrix[,3]` (available once you run the spadesCBMdefaults.r module). The default example for Saskatchewan is given in the objects of the global script as follows:

```{r echo=TRUE, eval=FALSE}
objects <- list(
  userDistFile = file.path(moduleDir,"spadesCBMinputsMerge","data","userDist.csv")
)
```

The userDist.csv information is used to build the `sim$mySpuDmids` in the simList(), where each disturbance provided (distName) is assosiated with its raster identification (rasterId), a spatial unit (spatial_unit_id) and the disturbance matrix (disturbance_matrix_id). If providing disturbances, the user must then provide rasters of which pixels get disturbed every year for the disturbances to be processed in the spadesCBMcore.r module. If no disturbance information is provided, the spadesCBMinputs.r module creates a default where distName are "fire" and "clearcut", and their respected rasterID are 1 and 2). **TO DO: make the 1984-2017 White and Wulder disturbance data available as per LandR.**


## spadesCBMm3ToBiomass
GrowthCurveComponentID Age MerchVolume - columns needed in the userGcM3
There is a file in the data folder of this module (cbmAdmin.csv) that identifies the administrative boundary name and linkes it to the AdminBoundaryID and the SpatialUnitID. 

## Growth information meta data

The growth curve meta data's main purpose is to identify the leading species. Leading species are used for finding the right parameters for the Boudewyn et al 2007 equations used to translate the m3/ha into aboveground biomass. The user provides leading species per growth curve and matches needs to match those species with the canfi_species and genus. We provide an example of the completed meta data file, and a list of species and genus to select the match from.

```{r eval=TRUE}
gcMetaEg <- fread(file.path(getwd(),"spadesCBMm3ToBiomass","data/gcMetaEg.csv"))
#growth_curve_id	growth_curve_component_id	species	canfi_species	genus	forest_type_id

```

The user can provide either 1) the gcMeta as described above, 2) a link to a file with the format descibed above (userMeta), or 3) provide just the growth curve identification (growth_curve_id) that will match a growth cureve to a pixel, and the leading species and he/she will be promted to select matching species in the .inputsObjects.



## Jurisdictions
 # identify jurisdiction matching CBM-legacy numbering with Boudewyn
  # jurisdiction params----------------------------------------------
  # choices are: 
  # table3$juris_id and table4$juris_id and table6$jur
  # AB BC MB NB NF NS NT NU ON PE QC SK YK
  # table5$juris_id
  # AB BC NB NF NT
need cbmAdmin?
gcMeta
"growth_curve_id","growth_curve_component_id","species","canfi_species","genus","forest_type_id"


## Growth information

In CBM-CFS3 and in spadesCBM, stand-level m3/ha are provided by the user. These are translated into biomass/ha before simulations. This is done using the Boudewyn et al 2007 stand-level parameters and needs leading species codes to match the Boudewyn et al 2007 (four tables). It is often the case that either the m3/ha curves provided are not realistic or that the translation of these is not realistic. For the RIA (and for now), visual assessments are necessary to get at least reasonable biomass increments prior to simulation. This is the most onorous part of user-input prep. Once the Boudewyn-species codes are associated with the growth curve (as in gcMeta for the RIA), for the RIA2019 all curves were "translated" into biomass. Corrections to biomass increments were done after the translation was done. 

* the m3/ha associated with each pixel for the RIA looked like this